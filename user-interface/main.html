<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gaming Platform</title>
    <link rel="stylesheet" href="global.css" />
    <link rel="stylesheet" href="tournement/tournament.css" />
    <link rel="stylesheet" href="games/style.css" />
    <link rel="stylesheet" href="events/events.css" />
    <link rel="stylesheet" href="recommendations/recommendations.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <script src="https://unpkg.com/lucide@latest"></script>
  </head>
  <body>
    <div class="app">
      <!-- Sidebar -->
      <div class="sidebar">
        <!-- User Profile Section - UPDATED TO LOAD DYNAMICALLY -->
        <div class="profile">
          <div class="avatar-container">
            <img
              id="userAvatar"
              src="/user-interface/img/iheb.jpg"
              alt="Profile"
              class="avatar"
            />
            <div class="status-indicator"></div>
          </div>
          <h2 class="username" id="userName">Loading...</h2>
          <p class="welcome-text" id="welcomeText">Authenticating...</p>
          
          <!-- User Role Badge -->
          <div id="userRoleBadge" style="
            margin-top: 20px;
            padding: 6px 12px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: none;
          ">
            👤 User
          </div>
        </div>
        
        
        <!-- Navigation -->
        <nav class="nav-menu">
          <a href="#" class="nav-item active" id="homeLink">
            <i data-lucide="home"></i>
            <span>Home</span>
            <i data-lucide="chevron-right" class="chevron"></i>
          </a>
          <a href="#games" class="nav-item" id="gamesLink">
            <i data-lucide="gamepad-2"></i>
            <span>Games</span>
            <i data-lucide="chevron-right" class="chevron"></i>
          </a>
          <a href="#tournament" class="nav-item" id="tournamentsLink">
            <i data-lucide="trophy"></i>
            <span>Tournaments</span>
            <i data-lucide="chevron-right" class="chevron"></i>
          </a>
          <a href="#" class="nav-item" id="eventsLink">
            <i data-lucide="calendar"></i>
            <span>Events</span>
            <i data-lucide="chevron-right" class="chevron"></i>
          </a>
          <!-- NEW RECOMMENDATIONS NAV ITEM -->
          <a href="#" class="nav-item" id="recommendationsLink">
            <i data-lucide="brain"></i>
            <span>AI Recommendations</span>
            <i data-lucide="chevron-right" class="chevron"></i>
          </a>
        </nav>
        
        <!-- Logout Button -->
        <button class="logout-btn" onclick="handleLogout()">
          <i data-lucide="log-out"></i>
          <span>Logout</span>
        </button>
        <!-- Footer -->
        <div class="sidebar-footer">
          <p>Gaming Zone v1.0</p>
        </div>
      </div>

      <!-- Home Section -->
      <div class="main-content" id="homeSection">
        <div class="content-container">
          <h1 class="main-title">Welcome to Gaming Zone</h1>
          <div class="feature-grid">
            <div class="feature-card">
              <i data-lucide="gamepad-2"></i>
              <h3>Featured Games</h3>
              <p>Explore our collection of trending games and new releases.</p>
            </div>
            <div class="feature-card">
              <i data-lucide="users"></i>
              <h3>Active Players</h3>
              <p>Join thousands of players in exciting multiplayer matches.</p>
            </div>
            <div class="feature-card">
              <i data-lucide="flame"></i>
              <h3>Live Tournaments</h3>
              <p>Compete in tournaments and win amazing prizes.</p>
            </div>
          </div>
          <div class="cta-section">
            <h2>🎮 Ready to Play?</h2>
            <p>
              Choose from our extensive library of games, join tournaments, or
              participate in upcoming events.
            </p>
            <div class="cta-buttons">
              <button class="btn btn-primary" id="browseGamesBtn">
                Browse Games
              </button>
              <button class="btn btn-secondary" id="viewTournamentsBtn">
                View Tournaments
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Games Section (hidden by default) -->
      <div class="main-content" id="gamesSection" style="display: none">
        <div class="content-container">
          <header>
            <h1>Games Explorer</h1>
            <div class="games-search-container">
              <input
                type="text"
                id="searchInput"
                placeholder="Search games..."
              />
              <i class="fas fa-search search-icon"></i>
            </div>
            <div class="filters">
              <select id="gamesCategoryFilter">
                <option value="">All Categories</option>
                <option value="action">Action</option>
                <option value="adventure">Adventure</option>
                <option value="rpg">RPG</option>
                <option value="sports">Sports</option>
                <option value="strategy">Strategy</option>
              </select>
              <select id="gamesRatingFilter">
                <option value="">All Ratings</option>
                <option value="5">5 Stars</option>
                <option value="4">4+ Stars</option>
                <option value="3">3+ Stars</option>
              </select>
            </div>
          </header>
          <main id="gamesGrid">
            <!-- Games will be injected here by main.js -->
          </main>
        </div>
      </div>

      <!-- Tournament Section (hidden by default) -->
      <div class="main-content" id="tournamentSection" style="display: none">
        <div class="content-container">
          <div class="tournament-h1">
            <h1 class="main-title">Available Tournaments</h1>
            <!-- Search and Filter Section -->
            <div class="tournament-search-container">
              <div class="tournament-search-bar">
                <input
                  type="text"
                  placeholder="Search tournaments..."
                  id="tournamentSearchInput"
                />
              </div>
              <div class="tournament-filter-section">
                <select id="tournamentCategoryFilter">
                  <option value="">All Categories</option>
                  <option value="fps">FPS Games</option>
                  <option value="moba">MOBA</option>
                  <option value="battle-royale">Battle Royale</option>
                  <option value="racing">Racing</option>
                  <option value="fighting">Fighting Games</option>
                </select>
              </div>
            </div>
          </div>
          <!-- Tournaments Grid -->
          <div class="tournament-grid" id="tournamentsGrid">
            <!-- Tournament cards get injected by tournament.js -->
          </div>
        </div>
      </div>
      <!-- Events Section -->
      <div class="main-content" id="eventsSection" style="display: none">
        <div class="content-container">
          <div class="events-h1">
            <h1 class="main-title">Gaming Events</h1>
            <div class="tournament-search-container">
              <div class="tournament-search-bar">
                <input
                  type="text"
                  id="eventSearchInput"
                  placeholder="Search events..."
                />
              </div>
              <div class="tournament-filter-section">
                <select id="eventCategoryFilter">
                  <option value="">All Categories</option>
                  <option value="convention">Conventions</option>
                  <option value="conference">Conference</option>
                  <option value="meetup">Meetups</option>
                  <option value="workshop">Workshops</option>
                  <option value="launch">Game Launches</option>
                </select>
                <select id="eventCountryFilter">
                  <option value="">All Countries</option>
                  <option value="usa">United States</option>
                  <option value="japan">Japan</option>
                  <option value="uk">United Kingdom</option>
                  <option value="germany">Germany</option>
                  <option value="france">France</option>
                </select>
              </div>
            </div>
          </div>
          <div class="events-grid" id="eventsGrid">
            <!-- Event cards will be injected by events.js -->
          </div>
        </div>
      </div>

      <!-- NEW RECOMMENDATIONS SECTION -->
      <div class="main-content" id="recommendationsSection" style="display: none">
        <div class="content-container">
          <div class="recommendations-header">
            <h1 class="main-title">🤖 AI Game Recommendations</h1>
            <p class="recommendations-subtitle">Personalized game suggestions powered by machine learning</p>
            
            <!-- Recommendation Settings -->
            <div class="recommendation-controls">
              <div style="display: flex; align-items: center; gap: 10px;">
                <label for="recommendationCount">Number of recommendations:</label>
                <select id="recommendationCount">
                  <option value="5">5 Games</option>
                  <option value="10">10 Games</option>
                  <option value="15">15 Games</option>
                  <option value="20">20 Games</option>
                </select>
              </div>
              
              <button id="refreshRecommendations" class="refresh-recommendations-btn">
                <i class="fas fa-sync-alt"></i>
                Refresh Recommendations
              </button>
            </div>
          </div>
          
          <!-- Recommendations Grid -->
          <div class="recommendations-grid" id="recommendationsGrid">
            <!-- AI recommendations will be injected here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Tournament Registration Modal -->
    <div class="tournament-modal" id="registrationModal" style="
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(8px);
    ">
      <div class="tournament-modal-content" style="
        background: linear-gradient(135deg, #1e293b, #334155);
        border-radius: 20px;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        border: 1px solid #475569;
        position: relative;
      ">
        <div class="tournament-modal-header" style="
          padding: 30px 30px 20px 30px;
          border-bottom: 1px solid #475569;
          text-align: center;
        ">
          <h2 style="margin: 0; color: #f8fafc; font-size: 1.8rem; font-weight: 700; margin-bottom: 8px;">🏆 Tournament Registration</h2>
          <p id="tournamentTitle" style="color: #94a3b8; margin: 0; font-size: 1.1rem;"></p>
          <button class="tournament-modal-close" onclick="closeModal()" style="
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #94a3b8;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s;
          " onmouseover="this.style.backgroundColor='#475569'; this.style.color='#ef4444'" onmouseout="this.style.backgroundColor='transparent'; this.style.color='#94a3b8'">
            ✕
          </button>
        </div>
        <div class="tournament-modal-body" style="padding: 30px;">
          <form id="registrationForm" onsubmit="handleRegistration(event)">
            <div style="margin-bottom: 20px;">
              <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #e2e8f0; font-size: 0.9rem;">👤 Your Username</label>
              <input type="text" name="username" id="regUsername" required style="
                width: 100%;
                padding: 12px 16px;
                border: 2px solid #475569;
                border-radius: 12px;
                font-size: 0.9rem;
                background: #ffffff;
                color: #1e293b;
                box-sizing: border-box;
                transition: border-color 0.2s;
              " onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#475569'" />
            </div>
            <div style="margin-bottom: 20px;">
              <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #e2e8f0; font-size: 0.9rem;">📧 Contact Email</label>
              <input type="email" id="contactEmail" name="email" required style="
                width: 100%;
                padding: 12px 16px;
                border: 2px solid #475569;
                border-radius: 12px;
                font-size: 0.9rem;
                background: #ffffff;
                color: #1e293b;
                box-sizing: border-box;
                transition: border-color 0.2s;
              " onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#475569'" />
            </div>
            <div style="margin-bottom: 30px;">
              <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #e2e8f0; font-size: 0.9rem;">🏅 Team Name</label>
              <input type="text" name="teamName" required style="
                width: 100%;
                padding: 12px 16px;
                border: 2px solid #475569;
                border-radius: 12px;
                font-size: 0.9rem;
                background: #ffffff;
                color: #1e293b;
                box-sizing: border-box;
                transition: border-color 0.2s;
              " onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#475569'" placeholder="Enter your team name" />
            </div>
            <div style="
              display: flex;
              gap: 12px;
              justify-content: flex-end;
              padding-top: 20px;
              border-top: 1px solid #475569;
            ">
              <button type="button" onclick="closeModal()" style="
                padding: 12px 24px;
                background: #475569;
                color: #e2e8f0;
                border: 2px solid #64748b;
                border-radius: 12px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
                font-size: 0.9rem;
              " onmouseover="this.style.backgroundColor='#64748b'" onmouseout="this.style.backgroundColor='#475569'">
                Cancel
              </button>
              <button type="submit" style="
                padding: 12px 24px;
                background: linear-gradient(135deg, #3b82f6, #1d4ed8);
                color: white;
                border: none;
                border-radius: 12px;
                font-weight: 700;
                cursor: pointer;
                transition: all 0.2s;
                box-shadow: 0 4px 14px rgba(59, 130, 246, 0.4);
                font-size: 0.9rem;
              " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 20px rgba(59, 130, 246, 0.6)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 14px rgba(59, 130, 246, 0.4)'">
                🎮 Register for Tournament
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Event Registration Modal -->
    <div class="tournament-modal" id="eventRegistrationModal">
      <div class="tournament-modal-content">
        <div class="tournament-modal-header">
          <h2>Event Registration</h2>
          <button class="tournament-modal-close" onclick="closeEventModal()">
            <i data-lucide="x"></i>
          </button>
        </div>
        <div class="tournament-modal-body">
          <h3 id="eventTitle" class="tournament-item-title"></h3>
          <form
            id="eventRegistrationForm"
            onsubmit="handleEventRegistration(event)"
          >
            <div class="tournament-form-group">
              <label for="teamName">Team Name</label>
              <input type="text" id="teamName" required />
            </div>
            <div class="tournament-form-group">
              <label for="playerCount">Number of Players</label>
              <input type="number" id="playerCount" min="1" max="5" required />
            </div>
            <div class="tournament-form-group">
              <label for="contactEmail">Contact Email</label>
              <input type="email" id="contactEmail" required />
            </div>
            <div class="tournament-form-group">
              <label for="discordId">Discord ID</label>
              <input type="text" id="discordId" required />
            </div>
            <div class="tournament-form-group">
              <label for="experience">Team Experience Level</label>
              <select id="experience" required>
                <option value="">Select experience level</option>
                <option value="beginner">Beginner</option>
                <option value="intermediate">Intermediate</option>
                <option value="advanced">Advanced</option>
                <option value="professional">Professional</option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary">
              Register for Event
            </button>
          </form>
        </div>
      </div>
    </div>

    <script src="main.js"></script>
    <script src="tournement/tournament.js"></script>
    <script src="games/main.js"></script>
    <script src="events/events.js"></script>
    <script src="recommendations/recommendations.js"></script>
    <script>
      // Global user object - will be populated from session
      let currentUser = null;
      
      // Check authentication on page load - ENHANCED VERSION
      document.addEventListener("DOMContentLoaded", async function () {
        console.log("🚀 DOM fully loaded, checking authentication...");
        
        // Check if user is authenticated and load user data
        await loadUserData();
        
        // Clear any existing games first
        const gamesGrid = document.getElementById("gamesGrid");
        if (gamesGrid) {
          console.log("🧹 Clearing existing games grid content...");
          gamesGrid.innerHTML =
            '<div style="color: white; text-align: center; padding: 40px;">Loading games from database...</div>';
        }

        setTimeout(() => {
          console.log(
            "🎮 Games Manager available:",
            typeof window.gamesManager
          );
          console.log("🎮 GamesManager class available:", typeof GamesManager);

          // Test API directly first
          console.log("🧪 Testing API call...");
          fetch("http://localhost/gaming-zone/api/games.php")
            .then((response) => response.json())
            .then((data) => {
              console.log("🧪 Direct API test result:", data);

              // Force display these games
              if (Array.isArray(data) && data.length > 0) {
                console.log("✅ API working, forcing display of games...");
                forceDisplayGames(data);
              } else {
                console.error("❌ API not returning games array");
              }
            })
            .catch((error) => {
              console.error("❌ API test failed:", error);
            });
        }, 1000);
      });

      // Enhanced function to load user data from multiple sources
      async function loadUserData() {
        console.log('🔐 Loading user authentication data...');
        
        try {
          // Method 1: Check if user data is in localStorage (from login)
          const storedUser = localStorage.getItem('gaming_zone_user');
          const authToken = localStorage.getItem('auth_token') || sessionStorage.getItem('auth_token');
          const isAuthenticated = sessionStorage.getItem('user_authenticated');
          
          console.log('💾 Stored user data:', storedUser ? 'Found' : 'Not found');
          console.log('🔑 Auth token:', authToken ? 'Found' : 'Not found');
          console.log('✅ Authentication flag:', isAuthenticated);
          
          if (storedUser && authToken && isAuthenticated === 'true') {
            // Parse stored user data
            currentUser = JSON.parse(storedUser);
            console.log('✅ User loaded from localStorage:', currentUser);
            
            // Verify token is still valid by calling API
            await verifyTokenWithServer(authToken);
            
            // Update UI with user data
            updateUserInterface();
            return;
          }
          
          // Method 2: Try to get user from server session
          console.log('🔄 Checking server session...');
          await checkServerAuthentication();
          
        } catch (error) {
          console.error('❌ Error loading user data:', error);
          // Redirect to login if no valid authentication found
          redirectToLogin();
        }
      }

      // Verify token with server
      async function verifyTokenWithServer(token) {
        try {
          console.log('🔍 Verifying token with server...');
          
          const response = await fetch('/gaming-zone/api/auth/verify-token.php', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ token: token })
          });
          
          if (response.ok) {
            const result = await response.json();
            if (result.success && result.user) {
              console.log('✅ Token verified, updating user data');
              currentUser = result.user;
              // Update localStorage with fresh user data
              localStorage.setItem('gaming_zone_user', JSON.stringify(currentUser));
              return true;
            }
          }
          
          console.log('⚠️ Token verification failed, but continuing with stored data');
          return false;
        } catch (error) {
          console.log('⚠️ Token verification error:', error.message);
          return false;
        }
      }

      // Check server authentication (fallback method)
      async function checkServerAuthentication() {
        try {
          const response = await fetch('/gaming-zone/api/auth/session.php', {
            method: 'GET',
            credentials: 'include' // Include session cookies
          });
          
          if (response.ok) {
            const authData = await response.json();
            console.log('🔐 Server authentication check:', authData);
            
            if (authData.authenticated && authData.user) {
              currentUser = authData.user;
              console.log('✅ User authenticated via server session:', currentUser);
              
              // Store in localStorage for persistence
              localStorage.setItem('gaming_zone_user', JSON.stringify(currentUser));
              sessionStorage.setItem('user_authenticated', 'true');
              
              updateUserInterface();
              return;
            }
          }
          
          throw new Error('No valid authentication found');
        } catch (error) {
          console.error('❌ Server authentication check failed:', error);
          throw error;
        }
      }

      // Update user interface with loaded data
      function updateUserInterface() {
        if (!currentUser) {
          console.error('❌ No user data available for UI update');
          return;
        }
        
        console.log('🎨 Updating user interface with:', currentUser);
        
        // Update username
        const userNameElement = document.getElementById('userName');
        if (userNameElement) {
          userNameElement.textContent = currentUser.name || currentUser.username || 'User';
        }
        
        // Update welcome text
        const welcomeTextElement = document.getElementById('welcomeText');
        if (welcomeTextElement) {
          const firstName = (currentUser.name || currentUser.username || 'User').split(' ')[0];
          welcomeTextElement.textContent = `Welcome back, ${firstName}!`;
        }
        
        // Update role badge
        const roleBadge = document.getElementById('userRoleBadge');
        if (roleBadge && currentUser.role) {
          let roleIcon = '👤';
          let roleColor = 'linear-gradient(135deg, #3b82f6, #1d4ed8)';
          
          switch (currentUser.role.toUpperCase()) {
            case 'ADMIN':
              roleIcon = '👑';
              roleColor = 'linear-gradient(135deg, #dc2626, #991b1b)';
              break;
            case 'MODERATOR':
              roleIcon = '🛡️';
              roleColor = 'linear-gradient(135deg, #7c3aed, #5b21b6)';
              break;
            case 'VIP':
              roleIcon = '⭐';
              roleColor = 'linear-gradient(135deg, #f59e0b, #d97706)';
              break;
            default:
              roleIcon = '👤';
              roleColor = 'linear-gradient(135deg, #3b82f6, #1d4ed8)';
          }
          
          roleBadge.innerHTML = `${roleIcon} ${currentUser.role}`;
          roleBadge.style.background = roleColor;
          roleBadge.style.display = 'block';
        }
        
        // Update avatar if imageUrl is available
        const avatarElement = document.getElementById('userAvatar');
        if (avatarElement && currentUser.imageUrl) {
          avatarElement.src = currentUser.imageUrl;
          avatarElement.onerror = function() {
            // Fallback to default avatar - FIXED PATH
            this.src = 'img/avatar.webp';
          };
        } else if (avatarElement) {
          // Set default avatar if no imageUrl provided
          avatarElement.src = 'img/avatar.webp';
          avatarElement.onerror = function() {
            // Ultimate fallback if avatar.webp doesn't exist
            this.src = 'img/iheb.jpg';
          };
        }
        
        // Update any other user-specific elements
        updateUserSpecificContent();
        
        console.log('✅ User interface updated successfully');
      }

      // Update content based on user data
      function updateUserSpecificContent() {
        // Pre-fill registration forms with user data
        const regUsernameInput = document.getElementById('regUsername');
        const contactEmailInput = document.getElementById('contactEmail');
        
        if (regUsernameInput && currentUser.name) {
          regUsernameInput.value = currentUser.name;
        }
        
        if (contactEmailInput && currentUser.email) {
          contactEmailInput.value = currentUser.email;
        }
        
        // Update main title to be more personal
        const mainTitle = document.querySelector('.main-title');
        if (mainTitle && mainTitle.textContent === 'Welcome to Gaming Zone') {
          const firstName = (currentUser.name || currentUser.username || 'User').split(' ')[0];
          mainTitle.textContent = `Welcome back, ${firstName}! 🎮`;
        }
        
        console.log('✅ User-specific content updated');
      }

      // Redirect to login if not authenticated
      function redirectToLogin() {
        console.log('🔄 No valid authentication found, redirecting to login...');
        
        // Clear any invalid data
        localStorage.removeItem('gaming_zone_user');
        localStorage.removeItem('auth_token');
        sessionStorage.removeItem('auth_token');
        sessionStorage.removeItem('user_authenticated');
        
        // Show message before redirect
        alert('⚠️ Authentication required!\n\nPlease login to access the gaming platform.');
        
        // Redirect to login page
        setTimeout(() => {
          window.location.href = '/gaming-zone/pages/loginuser/index.html';
        }, 1000);
      }

      // Check if user is authenticated
      async function checkAuthentication() {
        try {
          const response = await fetch('http://localhost/gaming-zone/api/auth.php', {
            method: 'GET',
            credentials: 'include' // Include session cookies
          });
          
          const authData = await response.json();
          console.log('🔐 Authentication check:', authData);
          
          if (authData.authenticated) {
            currentUser = authData.user;
            console.log('✅ User authenticated:', currentUser);
            
            // Update UI with user info
            document.querySelector('.username').textContent = currentUser.name;
            document.querySelector('.welcome-text').textContent = `Welcome back, ${currentUser.name.split(' ')[0]}!`;
          } else {
            console.log('❌ User not authenticated');
            // For demo purposes, auto-login the demo user
            await demoLogin();
          }
        } catch (error) {
          console.error('❌ Authentication check failed:', error);
          // Fallback to demo login
          await demoLogin();
        }
      }

      // Demo login function (for development)
      async function demoLogin() {
        try {
          const response = await fetch('http://localhost/gaming-zone/api/auth.php', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({
              action: 'login',
              email: 'iheb@example.com'
            })
          });
          
          const result = await response.json();
          console.log('🔐 Demo login result:', result);
          
          if (result.success) {
            currentUser = result.user;
            console.log('✅ Demo login successful:', currentUser);
            
            // Update UI
            document.querySelector('.username').textContent = currentUser.name;
            document.querySelector('.welcome-text').textContent = `Welcome back, ${currentUser.name.split(' ')[0]}!`;
          } else {
            console.error('❌ Demo login failed:', result.error);
            // Fallback to hardcoded user for demo
            currentUser = {
              id: 'user-001',
              name: 'Elazheri Iheb',
              email: 'iheb@example.com',
              role: 'USER'
            };
          }
        } catch (error) {
          console.error('❌ Demo login error:', error);
          // Fallback to hardcoded user
          currentUser = {
            id: 'user-001',
            name: 'Elazheri Iheb',
            email: 'iheb@example.com',
            role: 'USER'
          };
        }
      }

      // Force display function
      function forceDisplayGames(games) {
        console.log("🎨 Force displaying games:", games.length);
        const gamesGrid = document.getElementById("gamesGrid");

        if (!gamesGrid) {
          console.error("❌ Games grid not found!");
          return;
        }

        // Set grid layout
        gamesGrid.style.cssText = `
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
          gap: 30px;
          margin-top: 30px;
          padding: 20px 0;
        `;

        const gamesHTML = games
          .map((game, index) => {
            console.log(`🎮 Processing game ${index + 1}:`, game.name);
            return `
            <div class="game-card" style="
              background: rgba(248, 250, 252, 0.05);
              backdrop-filter: blur(20px);
              border: 1px solid rgba(248, 250, 252, 0.1);
              border-radius: 20px;
              overflow: hidden;
              transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
              position: relative;
              box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            " onmouseover="this.style.transform='translateY(-10px)'; this.style.boxShadow='0 25px 50px rgba(0, 0, 0, 0.3)'; this.style.borderColor='rgba(59, 130, 246, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 32px rgba(0, 0, 0, 0.1)'; this.style.borderColor='rgba(248, 250, 252, 0.1)'">
              
              <div class="game-image" style="
                position: relative;
                height: 220px;
                overflow: hidden;
                background: linear-gradient(45deg, #667eea, #764ba2);
              ">
                <img src="${
                  game.imageUrl ||
                  "https://images.unsplash.com/photo-1542751371-adc38448a05e?w=400"
                }" 
                     alt="${game.name}" 
                     style="
                       width: 100%; 
                       height: 100%; 
                       object-fit: cover;
                       transition: transform 0.3s ease;
                     "
                     onmouseover="this.style.transform='scale(1.05)'"
                     onmouseout="this.style.transform='scale(1)'"
                     onerror="this.src='https://images.unsplash.com/photo-1542751371-adc38448a05e?w=400'">
                
                <div style="
                  position: absolute;
                  top: 15px;
                  right: 15px;
                  background: rgba(0, 0, 0, 0.7);
                  color: #fbbf24;
                  padding: 6px 12px;
                  border-radius: 20px;
                  font-size: 0.8rem;
                  font-weight: 600;
                  display: flex;
                  align-items: center;
                  gap: 4px;
                ">
                  ⭐ ${game.averageRating || "0.0"}
                </div>
                
                <div style="
                  position: absolute;
                  bottom: 0;
                  left: 0;
                  right: 0;
                  background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
                  padding: 20px 0 10px;
                "></div>
              </div>
              
              <div class="game-info" style="padding: 25px;">
                <div style="margin-bottom: 15px;">
                  <h3 style="
                    color: #f8fafc;
                    margin: 0 0 8px 0;
                    font-size: 1.4rem;
                    font-weight: 700;
                    line-height: 1.2;
                  ">${game.name}</h3>
                  
                  <div style="
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    margin-bottom: 12px;
                  ">
                    <span style="
                      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
                      color: white;
                      padding: 4px 12px;
                      border-radius: 15px;
                      font-size: 0.75rem;
                      font-weight: 600;
                      text-transform: uppercase;
                      letter-spacing: 0.5px;
                    ">📂 ${game.categoryName || "Unknown"}</span>
                  </div>
                </div>
                
                <p style="
                  color: #cbd5e1;
                  font-size: 0.9rem;
                  line-height: 1.6;
                  margin-bottom: 20px;
                  display: -webkit-box;
                  -webkit-line-clamp: 3;
                  -webkit-box-orient: vertical;
                  overflow: hidden;
                ">${
                  game.description ||
                  "Experience an amazing gaming adventure with stunning graphics and immersive gameplay."
                }</p>
                
                <div style="
                  display: flex;
                  gap: 10px;
                  margin-bottom: 20px;
                  flex-wrap: wrap;
                ">
                  ${
                    game.minAge
                      ? `<span style="
                    background: rgba(59, 130, 246, 0.15);
                    color: #93c5fd;
                    padding: 6px 14px;
                    border-radius: 20px;
                    font-size: 0.8rem;
                    font-weight: 600;
                    border: 1px solid rgba(59, 130, 246, 0.3);
                  ">🔞 Age: ${game.minAge}+</span>`
                      : ""
                  }
                  
                  ${
                    game.targetGender
                      ? `<span style="
                    background: rgba(236, 72, 153, 0.15);
                    color: #f9a8d4;
                    padding: 6px 14px;
                    border-radius: 20px;
                    font-size: 0.8rem;
                    font-weight: 600;
                    border: 1px solid rgba(236, 72, 153, 0.3);
                  ">👤 ${game.targetGender}</span>`
                      : ""
                  }
                </div>
                
                <div style="
                  display: flex;
                  gap: 12px;
                  margin-top: auto;
                ">
                  <button onclick="alert('🎮 Launching ${
                    game.name
                  }!\\n\\nGet ready for an epic gaming experience!')" style="
                    flex: 1;
                    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
                    color: white;
                    border: none;
                    padding: 14px 20px;
                    border-radius: 12px;
                    font-weight: 700;
                    font-size: 0.9rem;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 8px;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                  " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 10px 25px rgba(59, 130, 246, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                    🎮 Play Now
                  </button>
                  
                  <button onclick="alert('📋 Game Details:\\n\\nName: ${
                    game.name
                  }\\nCategory: ${game.categoryName}\\nRating: ${
              game.averageRating
            }\\nAge: ${game.minAge}+\\n\\nDescription: ${
              game.description
            }')" style="
                    background: rgba(248, 250, 252, 0.1);
                    color: #e2e8f0;
                    border: 2px solid rgba(248, 250, 252, 0.2);
                    padding: 14px 16px;
                    border-radius: 12px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                  " onmouseover="this.style.backgroundColor='rgba(248, 250, 252, 0.15)'; this.style.borderColor='rgba(59, 130, 246, 0.5)'" onmouseout="this.style.backgroundColor='rgba(248, 250, 252, 0.1)'; this.style.borderColor='rgba(248, 250, 252, 0.2)'">
                    ℹ️
                  </button>
                </div>
              </div>
            </div>
          `;
          })
          .join("");

        console.log("📝 Setting games HTML...");
        gamesGrid.innerHTML = gamesHTML;
        console.log("✅ Games should now be visible with improved UI!");
      }

      // Navigation functionality - UPDATED TO INCLUDE RECOMMENDATIONS
      const navItems = document.querySelectorAll('.nav-item');
      const sections = ['homeSection', 'gamesSection', 'tournamentSection', 'eventsSection', 'recommendationsSection'];
      
      navItems.forEach(item => {
        item.addEventListener('click', function(e) {
          e.preventDefault();
          
          console.log('🔄 Navigation clicked:', this.getAttribute('id'));
          
          // Remove active class from all nav items
          navItems.forEach(nav => nav.classList.remove('active'));
          
          // Add active class to clicked item
          this.classList.add('active');
          
          // Hide all sections
          sections.forEach(sectionId => {
            const section = document.getElementById(sectionId);
            if (section) {
              section.style.display = 'none';
            }
          });
          
          // Show target section
          const targetSection = this.getAttribute('id');
          let sectionToShow = '';
          
          switch(targetSection) {
            case 'homeLink':
              sectionToShow = 'homeSection';
              break;
            case 'gamesLink':
              sectionToShow = 'gamesSection';
              // Force games initialization
              setTimeout(() => {
                console.log('🎮 Attempting to initialize games...');
                loadGamesDirectly();
              }, 300);
              break;
            case 'tournamentsLink':
              sectionToShow = 'tournamentSection';
              // Force tournaments initialization
              setTimeout(() => {
                console.log('🏆 Attempting to initialize tournaments...');
                loadTournamentsDirectly();
              }, 300);
              break;
            case 'eventsLink':
              sectionToShow = 'eventsSection';
              // Force events initialization
              setTimeout(() => {
                console.log('🎉 Attempting to initialize events...');
                loadEventsDirectly();
              }, 300);
              break;
            case 'recommendationsLink':
              sectionToShow = 'recommendationsSection';
              // Force recommendations initialization
              setTimeout(() => {
                console.log('🤖 Attempting to initialize AI recommendations...');
                if (window.recommendationsManager) {
                  window.recommendationsManager.loadRecommendations();
                }
              }, 300);
              break;
          }
          
          const section = document.getElementById(sectionToShow);
          if (section) {
            section.style.display = 'block';
            console.log(`✅ Switched to section: ${sectionToShow}`);
          }
        });
      });

      // GAMES LOADING - ADD MISSING FUNCTION
      async function loadGamesDirectly() {
        console.log('🔧 Loading games directly...');
        
        try {
          const response = await fetch('/gaming-zone/api/games.php');
          console.log('📡 Games API response status:', response.status);
          
          const games = await response.json();
          console.log('📦 Direct games fetch result:', games);
          
          if (Array.isArray(games) && games.length > 0) {
            forceDisplayGames(games);
          } else {
            showNoGamesMessage();
          }
        } catch (error) {
          console.error('❌ Direct games loading failed:', error);
          showGamesErrorMessage(error.message);
        }
      }

      function showNoGamesMessage() {
        const gamesGrid = document.getElementById('gamesGrid');
        if (gamesGrid) {
          gamesGrid.innerHTML = `
            <div style="text-align: center; padding: 60px 20px; color: #94a3b8; grid-column: 1 / -1;">
              <i class="fas fa-gamepad" style="font-size: 4rem; color: #475569; margin-bottom: 20px;"></i>
              <h3 style="font-size: 1.5rem; color: #f8fafc; margin-bottom: 12px;">No Games Available</h3>
              <p>No games found in the database</p>
            </div>
          `;
        }
      }

      function showGamesErrorMessage(message) {
        const gamesGrid = document.getElementById('gamesGrid');
        if (gamesGrid) {
          gamesGrid.innerHTML = `
            <div style="text-align: center; padding: 60px 20px; color: #94a3b8; grid-column: 1 / -1;">
              <i class="fas fa-exclamation-triangle" style="font-size: 4rem; color: #dc2626; margin-bottom: 20px;"></i>
              <h3 style="font-size: 1.5rem; color: #f8fafc; margin-bottom: 12px;">Error Loading Games</h3>
              <p style="color: #ef4444; margin-bottom: 20px;">${message}</p>
              <button onclick="loadGamesDirectly()" style="
                background: linear-gradient(135deg, #3b82f6, #1d4ed8);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                margin-top: 20px;
              ">
                <i class="fas fa-refresh"></i>
                Try Again
              </button>
            </div>
          `;
        }
      }

      // TOURNAMENTS LOADING - ADD MISSING FUNCTION
      async function loadTournamentsDirectly() {
        console.log('🔧 Loading tournaments directly...');
        
        const tournamentsGrid = document.getElementById('tournamentsGrid');
        if (!tournamentsGrid) {
          console.error('❌ Tournaments grid not found');
          return;
        }

        // Show loading message
        tournamentsGrid.innerHTML = `
          <div style="text-align: center; padding: 60px 20px; color: #94a3b8; grid-column: 1 / -1;">
            <i class="fas fa-spinner fa-spin" style="font-size: 4rem; color: #475569; margin-bottom: 20px;"></i>
            <h3 style="font-size: 1.5rem; color: #f8fafc; margin-bottom: 12px;">Loading Tournaments...</h3>
            <p>Please wait while we fetch the latest tournaments</p>
          </div>
        `;
        
        try {
          console.log('📡 Fetching tournaments from API...');
          const response = await fetch('/gaming-zone/api/tournaments.php', {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            },
            credentials: 'include'
          });
          
          console.log('📡 Tournaments API response status:', response.status);
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const tournaments = await response.json();
          console.log('📦 Tournaments API response data:', tournaments);
          
          if (Array.isArray(tournaments) && tournaments.length > 0) {
            console.log(`✅ Found ${tournaments.length} tournaments, displaying them...`);
            displayTournamentsDirectly(tournaments);
          } else if (Array.isArray(tournaments) && tournaments.length === 0) {
            console.log('ℹ️ No tournaments found in database');
            showNoTournamentsMessage();
          } else {
            console.error('❌ Invalid tournaments data structure:', tournaments);
            throw new Error('Invalid tournaments data received from server');
          }
        } catch (error) {
          console.error('❌ Tournaments loading failed:', error);
          showTournamentsErrorMessage(error.message);
        }
      }

      function displayTournamentsDirectly(tournaments) {
        console.log('🎨 Displaying tournaments directly...', tournaments.length);
        
        const tournamentsGrid = document.getElementById('tournamentsGrid');
        if (!tournamentsGrid) {
          console.error('❌ Tournaments grid not found');
          return;
        }

        // Set grid layout
        tournamentsGrid.style.cssText = `
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
          gap: 30px;
          margin-top: 30px;
          padding: 20px 0;
        `;
        
        const tournamentsHTML = tournaments.map(tournament => {
          console.log('🏆 Processing tournament:', tournament);
          
          // Safely get tournament properties with fallbacks
          const tournamentId = tournament.id || 'unknown';
          const tournamentName = tournament.name || 'Unnamed Tournament';
          const tournamentDescription = tournament.description || 'Join this exciting tournament and compete with the best players!';
          const tournamentImageUrl = tournament.imageUrl || 'https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=500&h=300&fit=crop';
          
          // Handle date parsing safely
          let startDate, endDate;
          try {
            startDate = new Date(tournament.startDate);
            endDate = new Date(tournament.endDate);
            if (isNaN(startDate.getTime())) startDate = new Date();
            if (isNaN(endDate.getTime())) endDate = new Date();
          } catch (e) {
            startDate = new Date();
            endDate = new Date();
          }

          const now = new Date();
          const isUpcoming = startDate > now;
          const isOngoing = startDate <= now && endDate >= now;
          const isEnded = endDate < now;
          
          let statusBadge = '';
          let statusColor = '';
          
          if (isEnded) {
            statusBadge = '🏁 Ended';
            statusColor = '#6b7280';
          } else if (isOngoing) {
            statusBadge = '🔴 Live';
            statusColor = '#dc2626';
          } else if (isUpcoming) {
            statusBadge = '🔥 Upcoming';
            statusColor = '#3b82f6';
          }

          // Safely escape tournament name for onclick handler
          const safeTournamentName = tournamentName.replace(/'/g, "\\'").replace(/"/g, '\\"');

          return `
            <div class="tournament-card" style="
              background: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(51, 65, 85, 0.9));
              backdrop-filter: blur(20px);
              border: 1px solid rgba(59, 130, 246, 0.2);
              border-radius: 20px;
              overflow: hidden;
              transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
              position: relative;
              box-shadow: 0 10px 40px rgba(59, 130, 246, 0.15);
              transform: translateY(0);
            " onmouseover="
              this.style.transform='translateY(-15px) scale(1.02)'; 
              this.style.boxShadow='0 25px 60px rgba(59, 130, 246, 0.3)'; 
              this.style.borderColor='rgba(59, 130, 246, 0.5)'
            " onmouseout="
              this.style.transform='translateY(0) scale(1)'; 
              this.style.boxShadow='0 10px 40px rgba(59, 130, 246, 0.15)'; 
              this.style.borderColor='rgba(59, 130, 246, 0.2)'
            ">
              
              <!-- Tournament Header Image -->
              <div class="tournament-image" style="
                position: relative;
                height: 240px;
                overflow: hidden;
                background: linear-gradient(135deg, #3b82f6, #1d4ed8, #06b6d4);
              ">
                <img src="${tournamentImageUrl}" 
                     alt="${tournamentName}" 
                     style="
                       width: 100%; 
                       height: 100%; 
                       object-fit: cover; 
                       transition: transform 0.4s ease;
                       filter: brightness(0.9);
                     "
                     onmouseover="this.style.transform='scale(1.1)'; this.style.filter='brightness(1.1)'"
                     onmouseout="this.style.transform='scale(1)'; this.style.filter='brightness(0.9)'"
                     onerror="this.src='https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=500&h=300&fit=crop'">
                
                <!-- Status Badge -->
                <div style="
                  position: absolute;
                  top: 20px;
                  left: 20px;
                  background: ${statusColor};
                  color: white;
                  padding: 8px 16px;
                  border-radius: 25px;
                  font-size: 0.85rem;
                  font-weight: 700;
                  text-transform: uppercase;
                  letter-spacing: 0.5px;
                  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
                ">
                  ${statusBadge}
                </div>
                
                <!-- Prize Pool Badge -->
                <div style="
                  position: absolute;
                  top: 20px;
                  right: 20px;
                  background: rgba(0, 0, 0, 0.8);
                  color: #fbbf24;
                  padding: 8px 16px;
                  border-radius: 25px;
                  font-size: 0.85rem;
                  font-weight: 600;
                  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
                ">
                  💰 $${tournament.prizePool || '0'}
                </div>
              </div>
              
              <!-- Tournament Content -->
              <div class="tournament-info" style="padding: 30px 25px;">
                <!-- Tournament Title -->
                <h3 style="
                  color: #f8fafc;
                  margin: 0 0 15px 0;
                  font-size: 1.5rem;
                  font-weight: 800;
                  line-height: 1.3;
                  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
                ">${tournamentName}</h3>
                
                <!-- Tournament Description -->
                <p style="
                  color: #cbd5e1;
                  font-size: 0.95rem;
                  line-height: 1.7;
                  margin-bottom: 25px;
                  display: -webkit-box;
                  -webkit-line-clamp: 3;
                  -webkit-box-orient: vertical;
                  overflow: hidden;
                ">${tournamentDescription}</p>
                
                <!-- Tournament Details Grid -->
                <div style="
                  display: grid;
                  grid-template-columns: 1fr 1fr;
                  gap: 20px;
                  margin-bottom: 25px;
                  padding: 20px;
                  background: rgba(59, 130, 246, 0.08);
                  border-radius: 15px;
                  border: 1px solid rgba(59, 130, 246, 0.2);
                ">
                  <!-- Start Date -->
                  <div style="text-align: center;">
                    <div style="
                      color: #93c5fd; 
                      font-size: 0.8rem; 
                      margin-bottom: 8px; 
                      font-weight: 600;
                      text-transform: uppercase;
                      letter-spacing: 0.5px;
                    ">🏁 Start Date</div>
                    <div style="
                      color: #f8fafc; 
                      font-weight: 700; 
                      font-size: 0.9rem;
                      line-height: 1.4;
                    ">${startDate.toLocaleDateString('en-US', { 
                      month: 'short', 
                      day: 'numeric' 
                    })}</div>
                  </div>
                  
                  <!-- Max Participants -->
                  <div style="text-align: center;">
                    <div style="
                      color: #93c5fd; 
                      font-size: 0.8rem; 
                      margin-bottom: 8px; 
                      font-weight: 600;
                      text-transform: uppercase;
                      letter-spacing: 0.5px;
                    ">👥 Max Players</div>
                    <div style="
                      color: #f8fafc; 
                      font-weight: 700; 
                      font-size: 0.9rem;
                      line-height: 1.4;
                      text-align: center;
                    ">${tournament.maxParticipants || 'Unlimited'}</div>
                  </div>
                </div>
                
                <!-- Registration Button -->
                <button onclick="openTournamentRegistrationModal('${tournamentId}', '${safeTournamentName}')" 
                        ${isEnded ? 'disabled' : ''} 
                        style="
                  width: 100%;
                  background: ${isEnded ? 
                    'linear-gradient(135deg, #6b7280, #4b5563)' : 
                    'linear-gradient(135deg, #3b82f6, #1d4ed8)'
                  };
                  color: white;
                  border: none;
                  padding: 18px 24px;
                  border-radius: 15px;
                  font-weight: 800;
                  font-size: 1rem;
                  cursor: ${isEnded ? 'not-allowed' : 'pointer'};
                  transition: all 0.3s ease;
                  text-transform: uppercase;
                  letter-spacing: 1px;
                  box-shadow: 0 8px 25px rgba(59, 130, 246, ${isEnded ? '0.1' : '0.3'});
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  gap: 10px;
                " ${!isEnded ? `
                  onmouseover="
                    this.style.transform='translateY(-3px)'; 
                    this.style.boxShadow='0 15px 35px rgba(59, 130, 246, 0.5)';
                    this.style.background='linear-gradient(135deg, #2563eb, #1e40af)';
                  " 
                  onmouseout="
                    this.style.transform='translateY(0)'; 
                    this.style.boxShadow='0 8px 25px rgba(59, 130, 246, 0.3)';
                    this.style.background='linear-gradient(135deg, #3b82f6, #1d4ed8)';
                  "
                ` : ''}>
                  ${isEnded ? 
                    '<i class="fas fa-flag-checkered"></i> Tournament Ended' : 
                    '<i class="fas fa-trophy"></i> Join Tournament'
                  }
                </button>
              </div>
            </div>
          `;
        }).join('');
        
        tournamentsGrid.innerHTML = tournamentsHTML;
        console.log(`✅ Successfully displayed ${tournaments.length} tournaments`);
      }

      function showNoTournamentsMessage() {
        const tournamentsGrid = document.getElementById('tournamentsGrid');
        if (tournamentsGrid) {
          tournamentsGrid.innerHTML = `
            <div style="text-align: center; padding: 60px 20px; color: #94a3b8; grid-column: 1 / -1;">
              <i class="fas fa-trophy" style="font-size: 4rem; color: #475569; margin-bottom: 20px;"></i>
              <h3 style="font-size: 1.5rem; color: #f8fafc; margin-bottom: 12px;">No Tournaments Available</h3>
              <p>No tournaments found in the database</p>
            </div>
          `;
        }
      }

      function showTournamentsErrorMessage(message) {
        const tournamentsGrid = document.getElementById('tournamentsGrid');
        if (tournamentsGrid) {
          tournamentsGrid.innerHTML = `
            <div style="text-align: center; padding: 60px 20px; color: #94a3b8; grid-column: 1 / -1;">
              <i class="fas fa-exclamation-triangle" style="font-size: 4rem; color: #dc2626; margin-bottom: 20px;"></i>
              <h3 style="font-size: 1.5rem; color: #f8fafc; margin-bottom: 12px;">Error Loading Tournaments</h3>
              <p style="color: #ef4444; margin-bottom: 20px;">${message}</p>
              <button onclick="loadTournamentsDirectly()" style="
                background: linear-gradient(135deg, #3b82f6, #1d4ed8);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                margin-top: 20px;
              ">
                <i class="fas fa-refresh"></i>
                Try Again
              </button>
            </div>
          `;
        }
      }

      // EVENTS FUNCTIONALITY - ENHANCED VERSION
      async function loadEventsDirectly() {
        console.log('🔧 Loading events directly...');
        
        const eventsGrid = document.getElementById('eventsGrid');
        if (!eventsGrid) {
          console.error('❌ Events grid not found');
          return;
        }

        // Show loading message
        eventsGrid.innerHTML = `
          <div style="text-align: center; padding: 60px 20px; color: #94a3b8; grid-column: 1 / -1;">
            <i class="fas fa-spinner fa-spin" style="font-size: 4rem; color: #475569; margin-bottom: 20px;"></i>
            <h3 style="font-size: 1.5rem; color: #f8fafc; margin-bottom: 12px;">Loading Events...</h3>
            <p>Please wait while we fetch the latest events</p>
          </div>
        `;
        
        try {
          console.log('📡 Fetching events from API...');
          const response = await fetch('/gaming-zone/api/events.php', {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            },
            credentials: 'include'
          });
          
          console.log('📡 Events API response status:', response.status);
          console.log('📡 Events API response headers:', response.headers.get('content-type'));
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const contentType = response.headers.get('content-type');
          if (!contentType || !contentType.includes('application/json')) {
            const textResponse = await response.text();
            console.error('❌ Non-JSON response received:', textResponse);
            throw new Error('Server returned invalid response format. Please check server logs.');
          }
          
          const events = await response.json();
          console.log('📦 Events API response data:', events);
          
          if (Array.isArray(events) && events.length > 0) {
            console.log(`✅ Found ${events.length} events, displaying them...`);
            displayEventsDirectly(events);
          } else if (Array.isArray(events) && events.length === 0) {
            console.log('ℹ️ No events found in database');
            showNoEventsMessage();
          } else {
            console.error('❌ Invalid events data structure:', events);
            throw new Error('Invalid events data received from server');
          }
        } catch (error) {
          console.error('❌ Events loading failed:', error);
          showEventsErrorMessage(error.message);
        }
      }

      function displayEventsDirectly(events) {
        console.log('🎨 Displaying events directly...', events.length);
        
        const eventsGrid = document.getElementById('eventsGrid');
        if (!eventsGrid) {
          console.error('❌ Events grid not found');
          return;
        }

        // Set grid layout
        eventsGrid.style.cssText = `
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
          gap: 25px;
          margin-top: 30px;
          padding: 20px 0;
        `;
        
        const eventsHTML = events.map(event => {
          console.log('🎉 Processing event:', event);
          
          // Safely get event properties with fallbacks
          const eventId = event.id || 'unknown';
          const eventName = event.name || 'Unnamed Event';
          const eventDescription = event.description || 'Join this exciting gaming event and connect with fellow gamers from around the world!';
          const eventPlace = event.place || 'Online Event';
          const eventImageUrl = event.imageUrl || 'https://images.unsplash.com/photo-1540575467063-178a50c2df87?w=500&h=300&fit=crop';
          
          // Handle date parsing safely
          let eventDate;
          try {
            eventDate = new Date(event.startDate);
            if (isNaN(eventDate.getTime())) {
              eventDate = new Date();
              console.warn('⚠️ Invalid date for event:', eventName);
            }
          } catch (e) {
            eventDate = new Date();
            console.warn('⚠️ Date parsing error for event:', eventName);
          }

          const now = new Date();
          const isUpcoming = eventDate > now;
          const isPast = eventDate < now;
          
          let statusBadge = '';
          let statusColor = '';
          
          if (isPast) {
            statusBadge = '📅 Past';
            statusColor = '#6b7280';
          } else if (isUpcoming) {
            statusBadge = '🔥 Upcoming';
            statusColor = '#10b981';
          } else {
            statusBadge = '🔴 Live';
            statusColor = '#ef4444';
          }

          // Safely escape event name for onclick handler
          const safeEventName = eventName.replace(/'/g, "\\'").replace(/"/g, '\\"');
          const safeEventPlace = eventPlace.replace(/'/g, "\\'").replace(/"/g, '\\"');

          return `
            <div class="event-card" style="
              background: linear-gradient(145deg, rgba(15, 23, 42, 0.9), rgba(30, 41, 59, 0.8));
              backdrop-filter: blur(16px);
              border: 1px solid rgba(148, 163, 184, 0.1);
              border-radius: 24px;
              overflow: hidden;
              transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
              position: relative;
              box-shadow: 
                0 4px 20px rgba(0, 0, 0, 0.15),
                0 1px 3px rgba(0, 0, 0, 0.1);
              transform: translateY(0) scale(1);
              cursor: pointer;
            " 
            onmouseover="
              this.style.transform='translateY(-8px) scale(1.02)'; 
              this.style.boxShadow='0 20px 40px rgba(0, 0, 0, 0.25), 0 8px 16px rgba(139, 92, 246, 0.15)'; 
              this.style.borderColor='rgba(139, 92, 246, 0.3)';
            " 
            onmouseout="
              this.style.transform='translateY(0) scale(1)'; 
              this.style.boxShadow='0 4px 20px rgba(0, 0, 0, 0.15), 0 1px 3px rgba(0, 0, 0, 0.1)'; 
              this.style.borderColor='rgba(148, 163, 184, 0.1)';
            ">
              
              <!-- Event Header with Image -->
              <div style="
                position: relative;
                height: 200px;
                overflow: hidden;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #8b5cf6 100%);
              ">
                <img src="${eventImageUrl}" 
                     alt="${eventName}" 
                     style="
                       width: 100%; 
                       height: 100%; 
                       object-fit: cover; 
                       transition: transform 0.5s ease;
                       opacity: 0.9;
                     "
                     onmouseover="this.style.transform='scale(1.1)'; this.style.opacity='1'"
                     onmouseout="this.style.transform='scale(1)'; this.style.opacity='0.9'"
                     onerror="this.src='https://images.unsplash.com/photo-1540575467063-178a50c2df87?w=500&h=300&fit=crop'">
                
                <!-- Status Badge -->
                <div style="
                  position: absolute;
                  top: 16px;
                  left: 16px;
                  background: ${statusColor};
                  color: white;
                  padding: 8px 16px;
                  border-radius: 50px;
                  font-size: 0.75rem;
                  font-weight: 700;
                  text-transform: uppercase;
                  letter-spacing: 0.5px;
                  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                  backdrop-filter: blur(8px);
                ">
                  ${statusBadge}
                </div>
                
                <!-- Event Type Badge -->
                <div style="
                  position: absolute;
                  top: 16px;
                  right: 16px;
                  background: rgba(0, 0, 0, 0.7);
                  color: #fbbf24;
                  padding: 8px 12px;
                  border-radius: 50px;
                  font-size: 0.75rem;
                  font-weight: 600;
                  backdrop-filter: blur(8px);
                ">
                  🎪 Event
                </div>

                <!-- Gradient Overlay -->
                <div style="
                  position: absolute;
                  bottom: 0;
                  left: 0;
                  right: 0;
                  height: 60px;
                  background: linear-gradient(transparent, rgba(15, 23, 42, 0.8));
                "></div>
              </div>
              
              <!-- Event Content -->
              <div style="padding: 24px;">
                <!-- Event Title -->
                <h3 style="
                  color: #f8fafc;
                  margin: 0 0 12px 0;
                  font-size: 1.25rem;
                  font-weight: 700;
                  line-height: 1.4;
                  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
                ">${eventName}</h3>
                
                <!-- Event Description -->
                <p style="
                  color: #cbd5e1;
                  font-size: 0.875rem;
                  line-height: 1.6;
                  margin-bottom: 20px;
                  display: -webkit-box;
                  -webkit-line-clamp: 3;
                  -webkit-box-orient: vertical;
                  overflow: hidden;
                  opacity: 0.9;
                ">${eventDescription}</p>
                
                <!-- Event Details -->
                <div style="
                  display: grid;
                  grid-template-columns: 1fr 1fr;
                  gap: 16px;
                  margin-bottom: 24px;
                  padding: 16px;
                  background: rgba(139, 92, 246, 0.05);
                  border-radius: 12px;
                  border: 1px solid rgba(139, 92, 246, 0.1);
                ">
                  <!-- Date Info -->
                  <div style="text-align: center;">
                    <div style="
                      color: #a78bfa; 
                      font-size: 0.75rem; 
                      margin-bottom: 4px; 
                      font-weight: 600;
                      text-transform: uppercase;
                      letter-spacing: 0.5px;
                    ">📅 Date</div>
                    <div style="
                      color: #f8fafc; 
                      font-weight: 700; 
                      font-size: 0.875rem;
                      line-height: 1.3;
                    ">${eventDate.toLocaleDateString('en-US', { 
                      month: 'short', 
                      day: 'numeric',
                      year: 'numeric'
                    })}</div>
                    <div style="
                      color: #a78bfa; 
                      font-size: 0.75rem; 
                      margin-top: 2px;
                      font-weight: 500;
                    ">${eventDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                  </div>
                  
                  <!-- Location Info -->
                  <div style="text-align: center;">
                    <div style="
                      color: #a78bfa; 
                      font-size: 0.75rem; 
                      margin-bottom: 4px; 
                      font-weight: 600;
                      text-transform: uppercase;
                      letter-spacing: 0.5px;
                    ">📍 Location</div>
                                       <div style="
                      color: #f8fafc; 
                      font-weight: 700; 
                      font-size: 0.875rem;
                      line-height: 1.3;
                      text-align: center;
                      word-break: break-word;
                    ">${eventPlace}</div>
                  </div>
                </div>
                
                <!-- Registration Button -->
                <button onclick="openEventRegistrationModal('${eventId}', '${safeEventName}', '${safeEventPlace}', '${eventDate.toISOString()}')" 
                        ${isPast ? 'disabled' : ''} 
                        style="
                  width: 100%;
                  background: ${isPast ? 
                    'linear-gradient(135deg, #6b7280, #4b5563)' : 
                    'linear-gradient(135deg, #8b5cf6, #7c3aed)'
                  };
                  color: white;
                  border: none;
                  padding: 16px 24px;
                  border-radius: 12px;
                  font-weight: 700;
                  font-size: 0.875rem;
                  cursor: ${isPast ? 'not-allowed' : 'pointer'};
                  transition: all 0.3s ease;
                  text-transform: uppercase;
                  letter-spacing: 0.5px;
                  box-shadow: ${isPast ? 'none' : '0 4px 14px rgba(139, 92, 246, 0.3)'};
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  gap: 8px;
                  opacity: ${isPast ? '0.6' : '1'};
                " ${!isPast ? `
                  onmouseover="
                    this.style.transform='translateY(-2px)'; 
                    this.style.boxShadow='0 8px 25px rgba(139, 92, 246, 0.4)';
                    this.style.background='linear-gradient(135deg, #7c3aed, #6d28d9)';
                  " 
                  onmouseout="
                    this.style.transform='translateY(0)'; 
                    this.style.boxShadow='0 4px 14px rgba(139, 92, 246, 0.3)';
                    this.style.background='linear-gradient(135deg, #8b5cf6, #7c3aed)';
                  "
                ` : ''}>
                  ${isPast ? 
                    '<i class="fas fa-calendar-times"></i> Event Ended' : 
                    '<i class="fas fa-ticket-alt"></i> Join Event'
                  }
                </button>
              </div>
            </div>
          `;
        }).join('');
        
        eventsGrid.innerHTML = eventsHTML;
        console.log(`✅ Successfully displayed ${events.length} events with enhanced UI`);
      }

      // EVENT REGISTRATION MODAL FUNCTIONALITY - FIXED VERSION
      let currentEventId = '';

      window.openEventRegistrationModal = function(eventId, eventName, eventPlace, eventDate) {
        console.log('🎯 Opening registration modal for event:', eventId, eventName);
        
        // Check if user is authenticated
        if (!currentUser || !currentUser.id) {
          alert('⚠️ Please login to register for events!\n\nYou will be redirected to the login page.');
          setTimeout(() => {
            window.location.href = '/gaming-zone/pages/loginuser/index.html';
          }, 2000);
          return;
        }
        
        // Validate event ID
        if (!eventId || eventId === 'undefined' || eventId === 'unknown') {
          alert('❌ Invalid event!\n\nPlease refresh the page and try again.');
          return;
        }
        
        currentEventId = eventId;
        
        // Set event data in modal
        const eventTitleElement = document.getElementById('eventTitle');
        if (eventTitleElement) {
          eventTitleElement.textContent = eventName || 'Event Registration';
        }
        
        // Pre-fill user data from authenticated session
        const teamNameInput = document.getElementById('teamName');
        const playerCountInput = document.getElementById('playerCount');
        const contactEmailInput = document.getElementById('contactEmail');
        const discordIdInput = document.getElementById('discordId');
        
        if (teamNameInput) {
          teamNameInput.value = `${currentUser.name || currentUser.username || 'Team'}_Squad`;
        }
        
        if (playerCountInput) {
          playerCountInput.value = '1';
        }
        
        if (contactEmailInput && currentUser.email) {
          contactEmailInput.value = currentUser.email;
        }
        
        if (discordIdInput && currentUser.username) {
          discordIdInput.value = currentUser.username;
        }
        
        // Show modal
        const modal = document.getElementById('eventRegistrationModal');
        if (modal) {
          modal.style.display = 'flex';
          modal.style.position = 'fixed';
          modal.style.top = '0';
          modal.style.left = '0';
          modal.style.width = '100%';
          modal.style.height = '100%';
          modal.style.backgroundColor = 'rgba(0, 0, 0, 0.85)';
          modal.style.zIndex = '1000';
          modal.style.justifyContent = 'center';
          modal.style.alignItems = 'center';
          modal.style.backdropFilter = 'blur(10px)';
          
          console.log('✅ Event registration modal opened successfully');
        } else {
          console.error('❌ Event registration modal not found');
          alert('❌ Registration form not available. Please refresh the page.');
        }
      };

      window.closeEventModal = function() {
        const modal = document.getElementById('eventRegistrationModal');
        if (modal) {
          modal.style.display = 'none';
          
          // Reset form completely
          const form = document.getElementById('eventRegistrationForm');
          if (form) {
            form.reset();
          }
          
          // Reset current event ID
          currentEventId = '';
          
          console.log('✅ Event registration modal closed and reset');
        }
      };

      window.handleEventRegistration = async function(event) {
        event.preventDefault();
        console.log('📝 Handling event registration form submission...');
        
        // Check authentication again before submission
        if (!currentUser || !currentUser.id) {
          alert('⚠️ Authentication required. Please login first.');
          return;
        }
        
        // Validate current event ID
        if (!currentEventId || currentEventId === 'unknown') {
          alert('❌ Invalid event. Please close and reopen the registration form.');
          return;
        }
        
        // Get form data - Updated to match API expectations
        const registrationData = {
          userId: currentUser.id,
          eventId: currentEventId,
          teamName: document.getElementById('teamName').value,
          playerCount: parseInt(document.getElementById('playerCount').value) || 1,
          contactEmail: document.getElementById('contactEmail').value,
          discordId: document.getElementById('discordId').value,
          experience: document.getElementById('experience').value
        };
        
        console.log('📤 Sending event registration data:', registrationData);
        
        // Validate required fields
        if (!registrationData.teamName || !registrationData.contactEmail || !registrationData.discordId || !registrationData.experience) {
          alert('📝 Please fill in all required fields!');
          return;
        }
        
        // Disable submit button to prevent double submission
        const submitBtn = event.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = '⏳ Registering...';
        
        try {
          // Use the correct event registration API endpoint
          const response = await fetch('/gaming-zone/api/event-registration.php', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify(registrationData)
          });

          console.log('📡 Event registration response status:', response.status);

          if (!response.ok) {
            const errorText = await response.text();
            console.error('❌ Response error:', errorText);
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const contentType = response.headers.get('content-type');
          if (!contentType || !contentType.includes('application/json')) {
            const textResponse = await response.text();
            console.error('❌ Non-JSON response received:', textResponse);
            throw new Error('Server returned invalid response format');
          }

          const result = await response.json();
          console.log('📥 Event registration response:', result);

          if (result.success) {
            // Success - show confirmation
            const eventName = document.getElementById('eventTitle').textContent;
            
            const successMessage = `🎉 Event Registration Successful!

✅ Event: ${eventName}
🏅 Team: ${registrationData.teamName}
👥 Players: ${registrationData.playerCount}
📧 Email: ${registrationData.contactEmail}
🎮 Discord: ${registrationData.discordId}
⭐ Experience: ${registrationData.experience}
📋 Status: Pending Approval

You will receive a confirmation email shortly with event details.

See you at the event! 🎉`;

            alert(successMessage);
            
            // Close modal and refresh events
            closeEventModal();
            
            // Optional: Refresh events to show updated status
            setTimeout(() => {
              loadEventsDirectly();
            }, 1000);
            
          } else {
            // Handle API errors
            let errorMessage = result.error || 'Event registration failed';
            
            if (errorMessage.includes('already registered')) {
              errorMessage = '⚠️ You are already registered for this event!\n\nPlease check your email for confirmation details.';
            } else if (errorMessage.includes('Event is full')) {
              errorMessage = '😢 Event is Full!\n\nThis event has reached its maximum capacity. Please try other available events.';
            } else if (errorMessage.includes('Event not found')) {
              errorMessage = '❌ Event Not Found!\n\nThis event may have been cancelled or removed. Please refresh the page and try again.';
            } else if (errorMessage.includes('User not found')) {
              errorMessage = '⚠️ Authentication Error!\n\nPlease logout and login again to refresh your session.';
            } else if (errorMessage.includes('Missing required fields')) {
              errorMessage = '📝 Please fill in all required fields:\n\n• Team Name\n• Player Count\n• Contact Email\n• Discord ID\n• Experience Level';
            }
            
            throw new Error(errorMessage);
          }
          
        } catch (error) {
          console.error('❌ Event registration failed:', error);
          
          let userFriendlyMessage = error.message;
          
          if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
            userFriendlyMessage = '🌐 Network Error!\n\nPlease check your internet connection and try again.';
          } else if (error.message.includes('HTTP 500')) {
            userFriendlyMessage = '⚙️ Server Error!\n\nThe server is experiencing issues. Please try again later or contact support.';
          } else if (error.message.includes('HTTP 404')) {
            userFriendlyMessage = '❌ API Not Found!\n\nThe event registration service is not available. Please contact support.';
          }
          
          alert(`❌ Event Registration Failed!\n\n${userFriendlyMessage}`);
          
        } finally {
          // Re-enable submit button
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      };

      // TOURNAMENT REGISTRATION MODAL FUNCTIONALITY - MISSING FUNCTIONS
      let currentTournamentId = '';

      window.openTournamentRegistrationModal = function(tournamentId, tournamentName) {
        console.log('🏆 Opening tournament registration modal for:', tournamentId, tournamentName);
        
        // Check if user is authenticated
        if (!currentUser || !currentUser.id) {
          alert('⚠️ Please login to register for tournaments!\n\nYou will be redirected to the login page.');
          setTimeout(() => {
            window.location.href = '/gaming-zone/pages/loginuser/index.html';
          }, 2000);
          return;
        }
        
        // Validate tournament ID
        if (!tournamentId || tournamentId === 'undefined' || tournamentId === 'unknown') {
          alert('❌ Invalid tournament!\n\nPlease refresh the page and try again.');
          return;
        }
        
        currentTournamentId = tournamentId;
        
        // Set tournament data in modal
        const tournamentTitleElement = document.getElementById('tournamentTitle');
        if (tournamentTitleElement) {
          tournamentTitleElement.textContent = tournamentName || 'Tournament Registration';
        }
        
        // Pre-fill user data from authenticated session
        const regUsernameInput = document.getElementById('regUsername');
        const contactEmailInput = document.querySelector('#registrationModal input[name="email"]');
        const teamNameInput = document.querySelector('#registrationModal input[name="teamName"]');
        
        if (regUsernameInput && currentUser.name) {
          regUsernameInput.value = currentUser.name;
        }
        
        if (contactEmailInput && currentUser.email) {
          contactEmailInput.value = currentUser.email;
        }
        
        if (teamNameInput) {
          teamNameInput.value = `${currentUser.name || currentUser.username || 'Team'}_Squad`;
        }
        
        // Show modal
        const modal = document.getElementById('registrationModal');
        if (modal) {
          modal.style.display = 'flex';
          modal.style.position = 'fixed';
          modal.style.top = '0';
          modal.style.left = '0';
          modal.style.width = '100%';
          modal.style.height = '100%';
          modal.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
          modal.style.zIndex = '1000';
          modal.style.justifyContent = 'center';
          modal.style.alignItems = 'center';
          modal.style.backdropFilter = 'blur(8px)';
          
          console.log('✅ Tournament registration modal opened successfully');
        } else {
          console.error('❌ Tournament registration modal not found');
          alert('❌ Registration form not available. Please refresh the page.');
        }
      };

      window.closeModal = function() {
        const modal = document.getElementById('registrationModal');
        if (modal) {
          modal.style.display = 'none';
          
          // Reset form completely
          const form = document.getElementById('registrationForm');
          if (form) {
            form.reset();
          }
          
          // Reset current tournament ID
          currentTournamentId = '';
          
          console.log('✅ Tournament registration modal closed and reset');
        }
      };

      window.handleRegistration = async function(event) {
        event.preventDefault();
        console.log('📝 Handling tournament registration form submission...');
        
        // Check authentication again before submission
        if (!currentUser || !currentUser.id) {
          alert('⚠️ Authentication required. Please login first.');
          return;
        }
        
        // Validate current tournament ID
        if (!currentTournamentId || currentTournamentId === 'unknown') {
          alert('❌ Invalid tournament. Please close and reopen the registration form.');
          return;
        }
        
        // Get form data
        const formData = new FormData(event.target);
        const registrationData = {
          userId: currentUser.id,
          tournamentId: currentTournamentId,
          username: formData.get('username') || currentUser.name,
          email: formData.get('email'),
          teamName: formData.get('teamName')
        };
        
        console.log('📤 Sending tournament registration data:', registrationData);
        
        // Validate required fields
        if (!registrationData.username || !registrationData.email || !registrationData.teamName) {
          alert('📝 Please fill in all required fields!');
          return;
        }
        
        // Disable submit button to prevent double submission
        const submitBtn = event.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = '⏳ Registering...';
        
        try {
          // Use tournament registration API endpoint
          const response = await fetch('/gaming-zone/api/tournament-registration.php', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify(registrationData)
          });

          console.log('📡 Tournament registration response status:', response.status);

          if (!response.ok) {
            const errorText = await response.text();
            console.error('❌ Response error:', errorText);
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const contentType = response.headers.get('content-type');
          if (!contentType || !contentType.includes('application/json')) {
            const textResponse = await response.text();
            console.error('❌ Non-JSON response received:', textResponse);
            throw new Error('Server returned invalid response format');
          }

          const result = await response.json();
          console.log('📥 Tournament registration response:', result);

          if (result.success) {
            // Success - show confirmation
            const tournamentName = document.getElementById('tournamentTitle').textContent;
            
            const successMessage = `🏆 Tournament Registration Successful!

✅ Tournament: ${tournamentName}
👤 Username: ${registrationData.username}
🏅 Team: ${registrationData.teamName}
📧 Email: ${registrationData.email}
📋 Status: Pending Approval

You will receive a confirmation email shortly with tournament details.

Good luck in the tournament! 🎮`;

            alert(successMessage);
            
            // Close modal and refresh tournaments
            closeModal();
            
            // Optional: Refresh tournaments to show updated status
            setTimeout(() => {
              loadTournamentsDirectly();
            }, 1000);
            
          } else {
            // Handle API errors
            let errorMessage = result.error || 'Tournament registration failed';
            
            if (errorMessage.includes('already registered')) {
              errorMessage = '⚠️ You are already registered for this tournament!\n\nPlease check your email for confirmation details.';
            } else if (errorMessage.includes('Tournament is full')) {
              errorMessage = '😢 Tournament is Full!\n\nThis tournament has reached its maximum capacity. Please try other available tournaments.';
            } else if (errorMessage.includes('Tournament not found')) {
              errorMessage = '❌ Tournament Not Found!\n\nThis tournament may have been cancelled or removed. Please refresh the page and try again.';
            } else if (errorMessage.includes('User not found')) {
              errorMessage = '⚠️ Authentication Error!\n\nPlease logout and login again to refresh your session.';
            } else if (errorMessage.includes('Missing required fields')) {
              errorMessage = '📝 Please fill in all required fields:\n\n• Username\n• Email\n• Team Name';
            }
            
            throw new Error(errorMessage);
          }
          
        } catch (error) {
          console.error('❌ Tournament registration failed:', error);
          
          let userFriendlyMessage = error.message;
          
          if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
            userFriendlyMessage = '🌐 Network Error!\n\nPlease check your internet connection and try again.';
          } else if (error.message.includes('HTTP 500')) {
            userFriendlyMessage = '⚙️ Server Error!\n\nThe server is experiencing issues. Please try again later or contact support.';
          } else if (error.message.includes('HTTP 404')) {
            userFriendlyMessage = '❌ API Not Found!\n\nThe tournament registration service is not available. Please contact support.';
          }
          
          alert(`❌ Tournament Registration Failed!\n\n${userFriendlyMessage}`);
          
        } finally {
          // Re-enable submit button
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      };

      // Add logout function
      window.handleLogout = function() {
        if (confirm('🚪 Are you sure you want to logout?')) {
          // Clear all stored authentication data
          localStorage.removeItem('gaming_zone_user');
          localStorage.removeItem('auth_token');
          sessionStorage.removeItem('auth_token');
          sessionStorage.removeItem('user_authenticated');
          
          // Show logout message
          alert('👋 You have been logged out successfully!\n\nRedirecting to login page...');
          
          // Redirect to login page
          setTimeout(() => {
            window.location.href = '/gaming-zone/pages/loginuser/index.html';
          }, 1500);
        }
      };

      // Initialize Lucide icons
      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }
    </script>
  </body>
</html>
